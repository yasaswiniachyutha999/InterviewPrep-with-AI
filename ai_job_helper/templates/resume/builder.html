{% extends "base.html" %}
{% load static %}

{% block title %}Resume Builder - AI Job Helper{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'resume/css/builder.css' %}">
<style>
/* Test inline CSS */
.resume-builder-container {
    display: flex;
    height: calc(100vh - 80px);
}
.form-panel {
    width: 48%;
    background-color: #ffffff;
    border-right: 1px solid #e9ecef;
    overflow-y: auto;
    padding: 20px;
}
.preview-panel {
    width: 52%;
    background-color: #ffffff;
    display: flex;
    flex-direction: column;
}
/* Resizer handle */
.panel-resizer {
    width: 6px;
    cursor: col-resize;
    background: #e5e7eb;
}
.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    border-bottom: 1px solid #e9ecef;
    cursor: pointer;
}
.section-title {
    display: flex;
    align-items: center;
    gap: 10px;
}
.section-title h3 {
    margin: 0;
    color: #2c3e50;
    font-size: 16px;
    font-weight: 600;
}
.expand-btn {
    background: none;
    border: none;
    font-size: 16px;
    cursor: pointer;
    color: #6c757d;
    padding: 5px;
    border-radius: 3px;
    transition: background-color 0.3s ease;
}
.expand-btn:hover {
    background-color: #e9ecef;
}
.section-content {
    padding: 0 20px;
    max-height: 0;
    overflow: hidden;
    transition: all 0.3s ease;
}
.section-content.expanded {
    padding: 20px;
    max-height: 2000px;
}
.form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-bottom: 15px;
}
.form-group {
    display: flex;
    flex-direction: column;
}
.form-group.full-width {
    grid-column: 1 / -1;
}
.form-group label {
    font-weight: 500;
    color: #495057;
    margin-bottom: 5px;
    font-size: 14px;
}
.form-control {
    padding: 8px 12px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 14px;
}
.form-control:focus {
    outline: none;
    border-color: #28a745;
    box-shadow: 0 0 0 2px rgba(40, 167, 69, 0.25);
}
.preview-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid #e9ecef;
}
.preview-content {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
}
.resume-preview {
    background: white;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 20px;
    min-height: 800px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.preview-placeholder {
    text-align: center;
    color: #6c757d;
    padding: 40px 20px;
}
.preview-placeholder h2 {
    color: #495057;
    margin-bottom: 10px;
}
.btn-primary, .btn-secondary {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    margin-left: 10px;
}
.btn-primary {
    background: #28a745;
    color: white;
}
.btn-secondary {
    background: #6c757d;
    color: white;
}
/* remove conflicting left alignment; centering handled via Tailwind in markup */
.resume-header h1 {
    font-size: 18pt;
    font-weight: bold;
    color: #000;
    margin-bottom: 0;
    line-height: 1.1;
}
.contact-info {
    color: #000;
    margin-bottom: 8px;
    font-size: 10pt;
    line-height: 1.1;
}
.contact-info a {
    color: #1d4ed8; /* blue-700 */
    text-decoration: none;
}
.contact-info a:hover {
    text-decoration: underline;
}
.contact-line {
    margin-bottom: 10px;
}
.social-links {
    display: flex;
    justify-content: center;
    gap: 15px;
    flex-wrap: wrap;
}
.social-links a {
    color: #1d4ed8; /* blue-700 */
    text-decoration: none;
    font-weight: 500;
}
.social-links a:hover {
    text-decoration: underline;
}
/* Section styling - Using TailwindCSS only */
.entry {
    margin-bottom: 12px;
}
.entry-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 5px;
}
.entry-title {
    font-weight: bold;
    color: #2c3e50;
}
.entry-subtitle {
    color: #6c757d;
    font-size: 14px;
}
.entry-date {
    color: #6c757d;
    font-size: 14px;
    white-space: nowrap;
}

/* Project Entry Styling */
.project-entry {
    margin-bottom: 15px;
}
.project-entry .entry-title {
    font-weight: bold;
    color: #2c3e50;
    font-size: 14px;
    margin-bottom: 8px;
}
.project-entry .entry-description {
    color: #495057;
    font-size: 12px;
    line-height: 1.4;
    margin-top: 8px;
}
.project-entry .entry-description a {
    color: #28a745;
    text-decoration: none;
    margin-left: 5px;
}
.project-entry .entry-description a:hover {
    text-decoration: underline;
}
.entry-description {
    color: #495057;
    line-height: 1.5;
    margin-top: 5px;
}
.skill-category {
    margin-bottom: 8px;
    line-height: 1.4;
}
.skill-category strong {
    color: #2c3e50;
}
.links-section {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #e9ecef;
}
.links-section label {
    display: block;
    font-weight: 500;
    color: #495057;
    margin-bottom: 10px;
}
.links-container {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 15px;
}
.link-item {
    display: flex;
    flex-direction: column;
}
.link-item label {
    font-weight: 500;
    color: #495057;
    margin-bottom: 5px;
    font-size: 14px;
}
.date-inputs, .score-inputs {
    display: flex;
    gap: 8px;
    align-items: center;
}
.date-inputs .form-control, .score-inputs .form-control {
    flex: 1;
}
.score-separator {
    font-weight: bold;
    color: #666;
    font-size: 16px;
    min-width: 20px;
    text-align: center;
}
.form-check-input {
    margin-right: 8px;
}
/* A4 Page Styling for Preview - EXACT match to reference image */
.resume-preview {
    background: white;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 20px;
    min-height: 800px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    width: 195mm; /* slightly narrower than full A4 to prevent clipping */
    max-width: 195mm;
    margin: 0 auto;
    font-family: 'Times New Roman', serif;
    font-size: 13px;
    line-height: 1.4;
    color: #000;
}
@media print {
    @page { size: A4; margin: 8mm; }
    .resume-preview {
        width: calc(100% - 16mm); /* A4 width minus page margins */
        max-width: none;
        box-shadow: none;
        border: none;
        padding: 0;
        box-sizing: border-box;
        margin: 0 auto;
    }
    .education-table { table-layout: fixed; width: 100%; margin: 0 auto; box-sizing: border-box; }
    .certification-table { table-layout: fixed; width: 100%; margin: 0 auto; box-sizing: border-box; }
    .education-table th, .education-table td { word-break: break-word; padding: 4px 6px; }
    .certification-table th, .certification-table td { word-break: break-word; padding: 4px 6px; }
}
/* Education Table Styling */
.education-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
    font-size: 12px;
    table-layout: fixed;
}
.education-table th {
    border: 1px solid #dee2e6;
    padding: 8px 12px;
    text-align: center;
    font-weight: bold;
    font-size: 12px;
    word-break: break-word;
}
.education-table td {
    border: 1px solid #dee2e6;
    padding: 8px 12px;
    text-align: left;
    vertical-align: top;
    word-break: break-word;
}
/* Column widths to prevent clipping */
.education-table colgroup col:nth-child(1) { width: 26%; }
.education-table colgroup col:nth-child(2) { width: 34%; }
.education-table colgroup col:nth-child(3) { width: 20%; }
.education-table colgroup col:nth-child(4) { width: 20%; }
</style>
{% endblock %}

{% block content %}
<div class="resume-builder-container">
    <!-- Left Panel - Form Sections -->
    <div class="form-panel">
        <div class="form-header">
            <h2 class="text-2xl font-bold mb-4">Resume Maker</h2>
            <div class="tab-buttons">
                <button class="tab-btn active" data-tab="personal">Resume Maker</button>
            </div>
        </div>

        <div class="form-content">
            <!-- Personal Information Section -->
            <div class="form-section active" id="personal-section">
                <div class="section-header">
                    <div class="section-title">
                        <span class="section-icon">👤</span>
                        <h3>Personal Info</h3>
                    </div>
                    <button class="expand-btn" data-section="personal">▼</button>
                </div>
                
                <div class="section-content">
                    <form id="personal-form" class="resume-form">
                        {% csrf_token %}
                        <div class="form-grid">
                            <div class="form-group">
                                <label>First Name</label>
                                {% if personal_form %}
                                    {{ personal_form.first_name }}
                                {% else %}
                                    <input type="text" name="first_name" class="form-control" placeholder="First Name">
                                {% endif %}
                            </div>
                            <div class="form-group">
                                <label>Last Name</label>
                                {% if personal_form %}
                                    {{ personal_form.last_name }}
                                {% else %}
                                    <input type="text" name="last_name" class="form-control" placeholder="Last Name">
                                {% endif %}
                            </div>
                            <div class="form-group">
                                <label>Email</label>
                                {% if personal_form %}
                                    {{ personal_form.email }}
                                {% else %}
                                    <input type="email" name="email" class="form-control" placeholder="Email">
                                {% endif %}
                            </div>
                            <div class="form-group">
                                <label>Phone</label>
                                {% if personal_form %}
                                    {{ personal_form.phone }}
                                {% else %}
                                    <input type="text" name="phone" class="form-control" placeholder="Phone">
                                {% endif %}
                            </div>
                            <div class="form-group">
                                <label>Address</label>
                                {% if personal_form %}
                                    {{ personal_form.address }}
                                {% else %}
                                    <input type="text" name="address" class="form-control" placeholder="Address">
                                {% endif %}
                            </div>
                            
                        </div>
                        
                        <div class="links-section">
                            <label>Links (3/5)</label>
                            <div class="links-container">
                                <div class="link-item">
                                    <label>LinkedIn</label>
                                    <input type="url" placeholder="LinkedIn URL" name="linkedin_url" class="form-control">
                                </div>
                                <div class="link-item">
                                    <label>GitHub</label>
                                    <input type="url" placeholder="GitHub URL" name="github_url" class="form-control">
                                </div>
                                <div class="link-item">
                                    <label>Portfolio</label>
                                    <input type="url" placeholder="Portfolio URL" name="website_url" class="form-control">
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Education Section -->
            <div class="form-section" id="education-section">
                <div class="section-header">
                    <div class="section-title">
                        <span class="section-icon">🎓</span>
                        <h3>Education</h3>
                    </div>
                    <button class="expand-btn" data-section="education">▼</button>
                </div>
                
                <div class="section-content">
                    <form id="education-form" class="resume-form">
                        {% csrf_token %}
                        <div class="education-entries">
                            {% if education_formset %}
                                {% for form in education_formset %}
                                <div class="education-entry" data-form-index="{{ forloop.counter0 }}">
                                    <div class="entry-header">
                                        <span class="entry-title">Institute Name</span>
                                        <div class="entry-controls">
                                            <button type="button" class="move-btn">⋮⋮</button>
                                            <button type="button" class="delete-btn">🗑️</button>
                                            <button type="button" class="toggle-btn">▲</button>
                                        </div>
                                    </div>
                                    
                                    <div class="entry-content">
                                        <div class="form-grid">
                                            <div class="form-group">
                                                <label>Institution</label>
                                                {{ form.institution }}
                                            </div>
                                            <div class="form-group">
                                                <label>Location</label>
                                                {{ form.location }}
                                            </div>
                                            <div class="form-group">
                                                <label>Degree Type</label>
                                                {{ form.degree_type }}
                                            </div>
                                            <div class="form-group">
                                                <label>Field of Study</label>
                                                {{ form.field_of_study }}
                                            </div>
                                            <div class="form-group">
                                                <label>From</label>
                                                {{ form.start_year|default:"" }}
                                            </div>
                                            <div class="form-group">
                                                <label>To</label>
                                                {{ form.grad_year }}
                                            </div>
                                            <div class="form-group">
                                                <label>CGPA/Marks</label>
                                                <div class="score-inputs">
                                                    {{ form.gpa }}
                                                    <span class="score-separator">/</span>
                                                    {{ form.gpa_scale }}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            {% endif %}
                        </div>
                        <button type="button" class="add-entry-btn" data-section="education">+ Add Education</button>
                    </form>
                </div>
            </div>

            <!-- Experience Section -->
            <div class="form-section" id="experience-section">
                <div class="section-header">
                    <div class="section-title">
                        <span class="section-icon">💼</span>
                        <h3>Experience</h3>
                    </div>
                    <button class="expand-btn" data-section="experience">▼</button>
                </div>
                
                <div class="section-content">
                    <form id="experience-form" class="resume-form">
                        {% csrf_token %}
                        <div class="experience-entries">
                            {% for form in experience_formset %}
                            <div class="experience-entry" data-form-index="{{ forloop.counter0 }}">
                                <div class="entry-header">
                                    <span class="entry-title">Experience Entry</span>
                                    <div class="entry-controls">
                                        <button type="button" class="move-btn">⋮⋮</button>
                                        <button type="button" class="delete-btn">🗑️</button>
                                        <button type="button" class="toggle-btn">▲</button>
                                    </div>
                                </div>
                                
                                <div class="entry-content">
                                    <div class="form-grid">
                                        <div class="form-group">
                                            <label>Company</label>
                                            {{ form.company }}
                                        </div>
                                        <div class="form-group">
                                            <label>Position</label>
                                            {{ form.position }}
                                        </div>
                                        <div class="form-group">
                                            <label>Location</label>
                                            {{ form.location }}
                                        </div>
                                        <div class="form-group">
                                            <label>Start Date</label>
                                            <div class="date-inputs">
                                                {{ form.start_month }}
                                                {{ form.start_year }}
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label>End Date</label>
                                            <div class="date-inputs">
                                                {{ form.end_month }}
                                                {{ form.end_year }}
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label>
                                                {{ form.is_current }}
                                                Current Position
                                            </label>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label>Description</label>
                                        {{ form.description }}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        <button type="button" class="add-entry-btn" data-section="experience">+ Add Experience</button>
                    </form>
                </div>
            </div>

            <!-- Skills Section -->
            <div class="form-section" id="skills-section">
                <div class="section-header">
                    <div class="section-title">
                        <span class="section-icon">🛠️</span>
                        <h3>Skillsets</h3>
                    </div>
                    <button class="expand-btn" data-section="skills">▼</button>
                </div>
                
                <div class="section-content">
                    <form id="skills-form" class="resume-form">
                        {% csrf_token %}
                        <div class="skills-entries">
                            {% for form in skill_formset %}
                            <div class="skill-entry" data-form-index="{{ forloop.counter0 }}">
                                <div class="entry-header">
                                    <span class="entry-title">Skill Entry</span>
                                    <div class="entry-controls">
                                        <button type="button" class="move-btn">⋮⋮</button>
                                        <button type="button" class="delete-btn">🗑️</button>
                                        <button type="button" class="toggle-btn">▲</button>
                                    </div>
                                </div>
                                
                                <div class="entry-content">
                                    <div class="form-grid">
                                        <div class="form-group">
                                            <label>Skill Name</label>
                                            {{ form.skill }}
                                        </div>
                                        <div class="form-group">
                                            <label>Category</label>
                                            {{ form.category }}
                                        </div>
                                        <div class="form-group">
                                            <label>Proficiency</label>
                                            {{ form.proficiency }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        <button type="button" class="add-entry-btn" data-section="skills">+ Add Skill</button>
                    </form>
                </div>
            </div>

            <!-- Projects Section -->
            <div class="form-section" id="projects-section">
                <div class="section-header">
                    <div class="section-title">
                        <span class="section-icon">🚀</span>
                        <h3>Projects</h3>
                    </div>
                    <button class="expand-btn" data-section="projects">▼</button>
                </div>
                
                <div class="section-content">
                    <form id="projects-form" class="resume-form">
                        {% csrf_token %}
                        <div class="projects-entries">
                            {% for form in project_formset %}
                            <div class="project-entry" data-form-index="{{ forloop.counter0 }}">
                                <div class="entry-header">
                                    <span class="entry-title">Project Entry</span>
                                    <div class="entry-controls">
                                        <button type="button" class="move-btn">⋮⋮</button>
                                        <button type="button" class="delete-btn">🗑️</button>
                                        <button type="button" class="toggle-btn">▲</button>
                                    </div>
                                </div>
                                
                                <div class="entry-content">
                                    <div class="form-grid">
                                        <div class="form-group">
                                            <label>Project Name</label>
                                            {{ form.name }}
                                        </div>
                                        <div class="form-group">
                                            <label>Technologies</label>
                                            {{ form.technologies }}
                                        </div>
                                        <div class="form-group">
                                            <label>Start Date</label>
                                            <div class="date-inputs">
                                                {{ form.start_month }}
                                                {{ form.start_year }}
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label>End Date</label>
                                            <div class="date-inputs">
                                                {{ form.end_month }}
                                                {{ form.end_year }}
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label>
                                                {{ form.is_ongoing }}
                                                Ongoing Project
                                            </label>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label>Description</label>
                                        {{ form.description }}
                                    </div>
                                    <div class="form-grid">
                                        <div class="form-group">
                                            <label>GitHub URL</label>
                                            {{ form.github_url }}
                                        </div>
                                        <div class="form-group">
                                            <label>Live URL</label>
                                            {{ form.live_url }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        <button type="button" class="add-entry-btn" data-section="projects">+ Add Project</button>
                    </form>
                </div>
            </div>

            <!-- Certifications Section -->
            <div class="form-section" id="certifications-section">
                <div class="section-header">
                    <div class="section-title">
                        <span class="section-icon">🏆</span>
                        <h3>Certifications</h3>
                    </div>
                    <button class="expand-btn" data-section="certifications">▼</button>
                </div>
                
                <div class="section-content">
                    <form id="certifications-form" class="resume-form">
                        {% csrf_token %}
                        <div class="certifications-entries">
                            {% for form in certification_formset %}
                            <div class="certification-entry" data-form-index="{{ forloop.counter0 }}">
                                <div class="entry-header">
                                    <span class="entry-title">Certification Entry</span>
                                    <div class="entry-controls">
                                        <button type="button" class="move-btn">⋮⋮</button>
                                        <button type="button" class="delete-btn">🗑️</button>
                                        <button type="button" class="toggle-btn">▲</button>
                                    </div>
                                </div>
                                
                                <div class="entry-content">
                                    <div class="form-grid">
                                        <div class="form-group">
                                            <label>Certification Name</label>
                                            {{ form.name }}
                                        </div>
                                        <div class="form-group">
                                            <label>Issuer</label>
                                            {{ form.issuer }}
                                        </div>
                                        <div class="form-group">
                                            <label>Issue Date</label>
                                            {{ form.issue_date }}
                                        </div>
                                        <div class="form-group">
                                            <label>Issue Year</label>
                                            {{ form.issue_year }}
                                        </div>
                                        <div class="form-group">
                                            <label>Credential ID</label>
                                            {{ form.credential_id }}
                                        </div>
                                        <div class="form-group">
                                            <label>Credential URL</label>
                                            {{ form.credential_url }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        <button type="button" class="add-entry-btn" data-section="certifications">+ Add Certification</button>
                    </form>
                </div>
            </div>

            
        </div>
    </div>

    <!-- Drag Resizer -->
    <div class="panel-resizer" id="panel-resizer" title="Drag to resize"></div>

    <!-- Right Panel - Live Preview -->
    <div class="preview-panel">
        <div class="preview-header">
            <h3>Live Preview</h3>
            <div class="preview-controls">
                <button id="save-pdf" class="btn-secondary">Save as PDF</button>
            </div>
        </div>
        
        <div class="preview-content">
            <div id="resume-preview" class="resume-preview" data-rest="{{ preview_rest }}">
                <!-- Resume preview will be generated here -->
                <div class="preview-placeholder">
                    <h2>Your Resume Preview</h2>
                    <p>Fill in the form on the left to see your resume preview here.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay removed -->
{% endblock %}

{% block extra_js %}
<script>
// Resume Builder JavaScript
console.log('Resume builder JavaScript loaded');

// Test if JavaScript is working
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing resume builder');
    
    // Test basic functionality
    console.log('Testing basic functionality...');
    
    // Add a simple test click to any button
    document.addEventListener('click', function(e) {
        console.log('Click detected on:', e.target);
    });
    
    // Section expand/collapse functionality (click anywhere on header)
    const sectionHeaders = document.querySelectorAll('.form-section .section-header');
    sectionHeaders.forEach(header => {
        header.addEventListener('click', function(e) {
            // Allow internal buttons to still work if any
            const btn = header.querySelector('.expand-btn');
            const section = btn?.dataset.section;
            if (!section) return;
            const content = document.querySelector(`#${section}-section .section-content`);
            if (!content) return;
            const isExpanded = content.classList.contains('expanded');
            content.classList.toggle('expanded');
            if (btn) btn.textContent = content.classList.contains('expanded') ? '▼' : '▲';
        });
    });
    
    // Auto-refresh preview on form input (no database saving)
    const formInputs = document.querySelectorAll('.resume-form input, .resume-form textarea, .resume-form select');
    formInputs.forEach(input => {
        input.addEventListener('input', function() {
            // Auto-update preview without saving to database
            updatePreview();

            // Check A4 overflow and warn
            requestAnimationFrame(() => {
                const preview = document.getElementById('resume-preview');
                if (!preview) return;
                const contentHeightMm = (preview.scrollHeight * 25.4) / 96; // px -> mm approx (96dpi)
                const maxHeightMm = 297 - 20 - 20; // A4 height minus 20mm top/bottom padding
                if (contentHeightMm > maxHeightMm) {
                    if (!document.getElementById('a4-warning')) {
                        const warn = document.createElement('div');
                        warn.id = 'a4-warning';
                        warn.style.color = '#b91c1c';
                        warn.style.fontSize = '12px';
                        warn.style.marginTop = '8px';
                        warn.textContent = 'Content exceeds one A4 page. Please shorten text to fit.';
                        preview.parentElement.insertBefore(warn, preview);
                    }
                } else {
                    const warn = document.getElementById('a4-warning');
                    if (warn) warn.remove();
                }
            });
        });
    });
    
    // Add entry buttons functionality
    document.querySelectorAll('.add-entry-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const section = this.dataset.section;
            addEntry(section);
        });
    });
    
    // Delete entry buttons functionality
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('delete-btn')) {
            if (confirm('Are you sure you want to delete this entry?')) {
                e.target.closest('.education-entry, .experience-entry, .skill-entry, .project-entry, .certification-entry, .additional-entry').remove();
                updatePreview();
            }
        }
    });
    
    // Toggle entry content
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('toggle-btn')) {
            const entryContent = e.target.closest('.education-entry, .experience-entry, .skill-entry, .project-entry, .certification-entry, .additional-entry').querySelector('.entry-content');
            entryContent.classList.toggle('expanded');
            e.target.textContent = entryContent.classList.contains('expanded') ? '▼' : '▲';
        }
    });
    
    // Save as PDF button (uses print to PDF)
    const printBtn = document.getElementById('save-pdf');
    if (printBtn) {
        printBtn.addEventListener('click', function() {
            const preview = document.getElementById('resume-preview');
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Resume - PDF</title>
                        <style>
                            @page { size: A4; margin: 8mm; }
                            body { font-family: 'Times New Roman', serif; margin: 0; padding: 8mm; font-size: 12px; line-height: 1.4; }
                            a { color: #1d4ed8; text-decoration: none; }
                            /* Minimal Tailwind utility equivalents for print window */
                            .text-center { text-align: center; }
                            .text-right { text-align: right; }
                            .font-bold { font-weight: 700; }
                            .uppercase { text-transform: uppercase; }
                            .text-base { font-size: 16px; }
                            .text-sm { font-size: 12px; }
                            .text-xs { font-size: 11px; }
                            .text-\\[13px\\] { font-size: 13px; }
                            .italic { font-style: italic; }
                            .flex { display: flex; }
                            .justify-between { justify-content: space-between; }
                            .items-start { align-items: flex-start; }
                            .leading-tight { line-height: 1.2; }
                            .mb-6 { margin-bottom: 1.5rem; }
                            .mb-4 { margin-bottom: 1rem; }
                            .mb-3 { margin-bottom: 0.75rem; }
                            .pb-1 { padding-bottom: 0.25rem; }
                            .border-b-2 { border-bottom-width: 2px; border-bottom-style: solid; }
                            .border-black { border-color: #000; }
                            .w-full { width: 100%; }
                            .table-fixed { table-layout: fixed; }
                            .border { border: 1px solid #000; }
                            .p-1 { padding: 0.25rem; }
                            .align-top { vertical-align: top; }
                            .text-gray-800 { color: #1f2937; }
                            .text-gray-700 { color: #374151; }
                            .text-gray-600 { color: #4b5563; }

                            .resume-header h1 { font-size: 18pt; font-weight: bold; text-align: center; margin-bottom: 0; }
                            .contact-info { text-align: center; margin-bottom: 8px; font-size: 12px; }
                            .education-table, .certification-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 11px; }
                            .education-table th, .education-table td, .certification-table th, .certification-table td { border: 1px solid #000; padding: 6px 8px; word-break: break-word; }
                            .education-table th, .certification-table th { font-weight: bold; text-align: center; }
                            @media print { body { padding: 8mm; } }
                        </style>
                    </head>
                    <body>
                        ${preview.innerHTML}
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        });
    }
    
    // Panel resize logic
    (function initResizer() {
        const resizer = document.getElementById('panel-resizer');
        const left = document.querySelector('.form-panel');
        const right = document.querySelector('.preview-panel');
        const container = document.querySelector('.resume-builder-container');
        if (!resizer || !left || !right || !container) return;

        let isDragging = false;
        resizer.addEventListener('mousedown', (e) => {
            isDragging = true;
            document.body.style.userSelect = 'none';
        });
        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            const rect = container.getBoundingClientRect();
            const offsetX = e.clientX - rect.left;
            const minLeft = 320; // px
            const maxLeft = rect.width - 320; // px
            const clamped = Math.max(minLeft, Math.min(maxLeft, offsetX));
            const leftPercent = (clamped / rect.width) * 100;
            const rightPercent = 100 - leftPercent - (resizer.offsetWidth / rect.width * 100);
            left.style.width = leftPercent + '%';
            right.style.width = rightPercent + '%';
        });
        document.addEventListener('mouseup', () => {
            isDragging = false;
            document.body.style.userSelect = '';
        });
    })();
    
    // LaTeX compilation button
    const compileBtn = document.getElementById('compile-resume');
    if (compileBtn) {
        compileBtn.addEventListener('click', function() {
            const overlay = document.getElementById('loading-overlay');
            overlay.style.display = 'flex';
            
            // For now, show a message since we need LaTeX installed
            setTimeout(() => {
                overlay.style.display = 'none';
                alert('LaTeX compilation requires LaTeX to be installed on the server. For now, use the Print HTML button to get a printable version.');
            }, 2000);
        });
    }
    
    // Function to update preview
    function updatePreview() {
        const preview = document.getElementById('resume-preview');
        const firstName = document.querySelector('input[name="first_name"]')?.value || '';
        const lastName = document.querySelector('input[name="last_name"]')?.value || '';
        const email = document.querySelector('input[name="email"]')?.value || '';
        const phone = document.querySelector('input[name="phone"]')?.value || '';
        const address = document.querySelector('input[name="address"]')?.value || '';
        const jobTitle = document.querySelector('input[name="job_title"]')?.value || '';
        const linkedin = document.querySelector('input[name="linkedin_url"]')?.value || '';
        const github = document.querySelector('input[name="github_url"]')?.value || '';
        const portfolio = document.querySelector('input[name="website_url"]')?.value || '';
        
        let html = '';
        
        if (firstName || lastName) {
            html += `
                <div class="resume-header text-center">
                    <h1 class="text-3xl font-bold tracking-wide text-gray-900">${firstName} ${lastName}</h1>
                    <div class="contact-info text-center text-sm text-gray-700">
                        <div class="contact-line">
                            ${email || phone || address ? 
                                [
                                    email ? `<a href="mailto:${email}">${email}</a>` : '',
                                    phone ? `<a href="tel:${phone}">${phone}</a>` : '',
                                    address || ''
                                ].filter(Boolean).join(' | ') : ''
                            }
                        </div>
                        <div class="social-links justify-center">
                            ${linkedin ? `<a class="text-blue-700" href="${linkedin}" target="_blank">LinkedIn</a>` : ''}
                            ${github ? `<a class="text-blue-700" href="${github}" target="_blank">GitHub</a>` : ''}
                            ${portfolio ? `<a class="text-blue-700" href="${portfolio}" target="_blank">Portfolio</a>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        // keep rest of preview intact...
        const existing = document.querySelector('#resume-preview');
        const rest = existing?.dataset.rest || '';

        // Inject only header now; the rest of sections are rendered elsewhere in the file
        // For simplicity, reuse the previously implemented section renders
       
        // Education section
        const educationEntries = document.querySelectorAll('.education-entry');
        if (educationEntries.length > 0) {
            html += '<div class="mb-6"><div class="text-base font-bold uppercase border-b-2 border-black pb-1 mb-3">EDUCATION</div>';
            html += `
                <table class="education-table w-full table-fixed mt-2 text-[12px] border-collapse">
                    <colgroup>
                        <col>
                        <col>
                        <col>
                        <col>
                    </colgroup>
                    <thead>
                        <tr class="text-center font-bold text-[12px]">
                            <th class="border border-black p-1">Degree</th>
                            <th class="border border-black p-1">Institute</th>
                            <th class="border border-black p-1">CGPA/Marks</th>
                            <th class="border border-black p-1">Year</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            educationEntries.forEach(entry => {
                const institution = entry.querySelector('input[name*="institution"]')?.value || '';
                const degreeType = entry.querySelector('input[name*="degree_type"]')?.value || '';
                const fieldOfStudy = entry.querySelector('input[name*="field_of_study"]')?.value || '';
                const location = entry.querySelector('input[name*="location"]')?.value || '';
                const startYear = entry.querySelector('input[name*="start_year"]')?.value || '';
                const gradYear = entry.querySelector('input[name*="grad_year"]')?.value || '';
                const gpa = entry.querySelector('input[name*="gpa"]')?.value || '';
                const gpaScale = entry.querySelector('input[name*="gpa_scale"]')?.value || '10.00';
                if (institution || degreeType) {
                    const degree = fieldOfStudy ? `${degreeType}, ${fieldOfStudy}` : degreeType;
                    const institute = location ? `${institution}, ${location}` : institution;
                    const marks = gpa ? `${gpa} / ${gpaScale}` : '';
                    html += `
                        <tr>
                            <td class="border border-black p-1 align-top">${degree}</td>
                            <td class="border border-black p-1 align-top">${institute}</td>
                            <td class="border border-black p-1 align-top">${marks}</td>
                            <td class="border border-black p-1 align-top">${startYear || gradYear ? `${startYear} - ${gradYear}`.trim() : ''}</td>
                        </tr>
                    `;
                }
            });
            html += `</tbody></table>`;
            html += '</div>';
        }

        // Experience section (Tailwind only)
        const experienceEntries = document.querySelectorAll('.experience-entry');
        if (experienceEntries.length > 0) {
            html += '<div class="mb-6"><div class="text-base font-bold text-gray-800 uppercase border-b-2 border-black pb-1 mb-3">EXPERIENCE</div>';
            experienceEntries.forEach(entry => {
                const company = entry.querySelector('input[name*="company"]')?.value || '';
                const position = entry.querySelector('input[name*="position"]')?.value || '';
                const location = entry.querySelector('input[name*="location"]')?.value || '';
                const startMonth = entry.querySelector('input[name*="start_month"]')?.value || '';
                const startYear = entry.querySelector('input[name*="start_year"]')?.value || '';
                const endMonth = entry.querySelector('input[name*="end_month"]')?.value || '';
                const endYear = entry.querySelector('input[name*="end_year"]')?.value || '';
                const isCurrent = entry.querySelector('input[name*="is_current"]')?.checked || false;
                const description = entry.querySelector('textarea[name*="description"]')?.value || '';
                if (company || position) {
                    const endDate = isCurrent ? 'Present' : `${endMonth} ${endYear}`;
                    const dateRange = `${startMonth} ${startYear} – ${endDate}`;
                    html += `
                        <div class="mb-4">
                            <div class="flex justify-between items-start leading-tight">
                                <div class="font-bold text-gray-800 text-sm">${position}</div>
                                <div class="italic text-gray-600 text-xs text-right">${location}</div>
                            </div>
                            <div class="flex justify-between items-start leading-tight">
                                <div class="italic text-gray-600 text-xs">${company}</div>
                                <div class="italic text-gray-600 text-xs text-right">${dateRange}</div>
                            </div>
                            <div class="text-gray-700 text-xs leading-tight mt-1">• ${description}</div>
                        </div>
                    `;
                }
            });
            html += '</div>';
        }
        
        // Skills section
        const skillEntries = document.querySelectorAll('.skill-entry');
        if (skillEntries.length > 0) {
            html += '<div class="mb-6"><div class="text-base font-bold uppercase border-b-2 border-black pb-1 mb-3">SKILLS SUMMARY</div>';
            
            // Group skills by category
            const skillCategories = {};
            skillEntries.forEach(entry => {
                const categoryEl = entry.querySelector('select[name*="category"], input[name*="category"]');
                const category = (categoryEl?.value || 'Other').trim() || 'Other';
                const skill = (entry.querySelector('input[name*="skill"]')?.value || '').trim();
                if (skill) {
                    if (!skillCategories[category]) {
                        skillCategories[category] = [];
                    }
                    skillCategories[category].push(skill);
                }
            });
            
            // Display skills by category
            Object.keys(skillCategories).forEach(category => {
                if (skillCategories[category].length > 0) {
                    html += `<div class="skill-category">• <strong>${category}:</strong> ${skillCategories[category].join(', ')}</div>`;
                }
            });
            
            html += '</div>';
        }
        
        // Projects section
        const projectEntries = document.querySelectorAll('.project-entry');
        if (projectEntries.length > 0) {
            html += '<div class="mb-6"><div class="text-base font-bold uppercase border-b-2 border-black pb-1 mb-3">PROJECTS</div>';
            projectEntries.forEach(entry => {
                const title = entry.querySelector('input[name*="title"]')?.value || '';
                const technologies = entry.querySelector('input[name*="technologies"]')?.value || '';
                const description = entry.querySelector('textarea[name*="description"]')?.value || '';
                const projectUrl = entry.querySelector('input[name*="project_url"]')?.value || '';
                const githubUrl = entry.querySelector('input[name*="github_url"]')?.value || '';
                
                if (title) {
                    const techText = technologies ? ` (${technologies})` : '';
                    const links = [];
                    if (projectUrl) links.push(`<a href="${projectUrl}" target="_blank">(View Project)</a>`);
                    if (githubUrl) links.push(`<a href="${githubUrl}" target="_blank">(GitHub)</a>`);
                    const linksText = links.length > 0 ? ` ${links.join(' ')}` : '';
                    
                    // Single inline line: Bold Title + (Tech) then description flows immediately; no borders
                    html += `
                        <div class="mb-2">
                            <span class="font-bold text-[13px]">${title}</span>${techText}: ${description}${linksText}
                        </div>
                    `;
                }
            });
            html += '</div>';
        }

        // Certifications section as a table
        const certificationEntries = document.querySelectorAll('.certification-entry');
        if (certificationEntries.length > 0) {
            html += '<div class="mb-6"><div class="text-base font-bold uppercase border-b-2 border-black pb-1 mb-3">CERTIFICATIONS</div>';
            html += `
                <table class="certification-table w-full table-fixed mt-2 text-[12px] border-collapse">
                    <thead>
                        <tr class="text-center font-bold text-[12px]">
                            <th class="border border-black p-1">Certification Authority</th>
                            <th class="border border-black p-1">Certificate</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            certificationEntries.forEach(entry => {
                const issuer = entry.querySelector('input[name*="issuer"]')?.value || '';
                const name = entry.querySelector('input[name*="name"]')?.value || '';
                if (issuer || name) {
                    html += `
                        <tr>
                            <td class="border border-black p-1 align-top">${issuer}</td>
                            <td class="border border-black p-1 align-top">${name}</td>
                        </tr>
                    `;
                }
            });
            html += `</tbody></table>`;
            html += '</div>';
        }
        
        if (html) {
            preview.innerHTML = html;
        } else {
            preview.innerHTML = `
                <div class="preview-placeholder">
                    <h2>Your Resume Preview</h2>
                    <p>Fill in the form on the left to see your resume preview here.</p>
                </div>
            `;
        }
    }
    
    // Function to add new entries
    function addEntry(sectionType) {
        const container = document.querySelector(`.${sectionType}-entries`);
        const formIndex = container.children.length;
        
        let entryHTML = '';
        
        if (sectionType === 'education') {
            entryHTML = `
                <div class="education-entry" data-form-index="${formIndex}">
                    <div class="entry-header">
                        <span class="entry-title">Institute Name</span>
                        <div class="entry-controls">
                            <button type="button" class="move-btn">⋮⋮</button>
                            <button type="button" class="delete-btn">🗑️</button>
                            <button type="button" class="toggle-btn">▲</button>
                        </div>
                    </div>
                    <div class="entry-content">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Institution</label>
                                <input type="text" name="education-${formIndex}-institution" class="form-control" placeholder="Institution Name">
                            </div>
                            <div class="form-group">
                                <label>Location</label>
                                <input type="text" name="education-${formIndex}-location" class="form-control" placeholder="Location">
                            </div>
                            <div class="form-group">
                                <label>Degree Type</label>
                                <input type="text" name="education-${formIndex}-degree_type" class="form-control" placeholder="Degree Type">
                            </div>
                            <div class="form-group">
                                <label>Field of Study</label>
                                <input type="text" name="education-${formIndex}-field_of_study" class="form-control" placeholder="Field of Study">
                            </div>
                            <div class="form-group">
                                <label>Year</label>
                                <input type="number" name="education-${formIndex}-grad_year" class="form-control" placeholder="Graduation Year">
                            </div>
                            <div class="form-group">
                                <label>CGPA/Marks</label>
                                <div class="score-inputs">
                                    <input type="number" name="education-${formIndex}-gpa" class="form-control" placeholder="CGPA/Marks" step="0.01">
                                    <span class="score-separator">/</span>
                                    <input type="text" name="education-${formIndex}-gpa_scale" class="form-control" placeholder="Out of" value="10.00">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        } else if (sectionType === 'experience') {
            entryHTML = `
                <div class="experience-entry" data-form-index="${formIndex}">
                    <div class="entry-header">
                        <span class="entry-title">Experience Entry</span>
                        <div class="entry-controls">
                            <button type="button" class="move-btn">⋮⋮</button>
                            <button type="button" class="delete-btn">🗑️</button>
                            <button type="button" class="toggle-btn">▲</button>
                        </div>
                    </div>
                    <div class="entry-content">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Company</label>
                                <input type="text" name="experience-${formIndex}-company" class="form-control" placeholder="Company Name">
                            </div>
                            <div class="form-group">
                                <label>Position</label>
                                <input type="text" name="experience-${formIndex}-position" class="form-control" placeholder="Position Title">
                            </div>
                            <div class="form-group">
                                <label>Location</label>
                                <input type="text" name="experience-${formIndex}-location" class="form-control" placeholder="Location">
                            </div>
                            <div class="form-group">
                                <label>Start Date</label>
                                <div class="date-inputs">
                                    <input type="text" name="experience-${formIndex}-start_month" class="form-control" placeholder="Start Month">
                                    <input type="number" name="experience-${formIndex}-start_year" class="form-control" placeholder="Start Year">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>End Date</label>
                                <div class="date-inputs">
                                    <input type="text" name="experience-${formIndex}-end_month" class="form-control" placeholder="End Month">
                                    <input type="number" name="experience-${formIndex}-end_year" class="form-control" placeholder="End Year">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" name="experience-${formIndex}-is_current" class="form-check-input">
                                    Current Position
                                </label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <textarea name="experience-${formIndex}-description" class="form-control" rows="4" placeholder="Job Description"></textarea>
                        </div>
                    </div>
                </div>
            `;
        } else if (sectionType === 'skills') {
            entryHTML = `
                <div class="skill-entry" data-form-index="${formIndex}">
                    <div class="entry-header">
                        <span class="entry-title">Skill Entry</span>
                        <div class="entry-controls">
                            <button type="button" class="move-btn">⋮⋮</button>
                            <button type="button" class="delete-btn">🗑️</button>
                            <button type="button" class="toggle-btn">▲</button>
                        </div>
                    </div>
                    <div class="entry-content">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Skill Name</label>
                                <input type="text" name="skills-${formIndex}-skill" class="form-control" placeholder="e.g., Python, React, AWS">
                            </div>
                            <div class="form-group">
                                <label>Category</label>
                                <select name="skills-${formIndex}-category" class="form-control">
                                    <option value="Languages">Languages</option>
                                    <option value="Frameworks">Frameworks</option>
                                    <option value="Tools">Tools</option>
                                    <option value="Platforms">Platforms</option>
                                    <option value="Soft Skills">Soft Skills</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        } else if (sectionType === 'projects') {
            entryHTML = `
                <div class="project-entry" data-form-index="${formIndex}">
                    <div class="entry-header">
                        <span class="entry-title">Project Entry</span>
                        <div class="entry-controls">
                            <button type="button" class="move-btn">⋮⋮</button>
                            <button type="button" class="delete-btn">🗑️</button>
                            <button type="button" class="toggle-btn">▲</button>
                        </div>
                    </div>
                    <div class="entry-content">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Project Title</label>
                                <input type="text" name="projects-${formIndex}-title" class="form-control" placeholder="Project Name">
                            </div>
                            <div class="form-group">
                                <label>Technologies</label>
                                <input type="text" name="projects-${formIndex}-technologies" class="form-control" placeholder="e.g., React, Node.js, MongoDB">
                            </div>
                            <div class="form-group">
                                <label>Project URL</label>
                                <input type="url" name="projects-${formIndex}-project_url" class="form-control" placeholder="https://project-url.com">
                            </div>
                            <div class="form-group">
                                <label>GitHub URL</label>
                                <input type="url" name="projects-${formIndex}-github_url" class="form-control" placeholder="https://github.com/username/project">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <textarea name="projects-${formIndex}-description" class="form-control" rows="3" placeholder="Project description"></textarea>
                        </div>
                    </div>
                </div>
            `;
        } else if (sectionType === 'certifications') {
            entryHTML = `
                <div class="certification-entry" data-form-index="${formIndex}">
                    <div class="entry-header">
                        <span class="entry-title">Certification Entry</span>
                        <div class="entry-controls">
                            <button type="button" class="move-btn">⋮⋮</button>
                            <button type="button" class="delete-btn">🗑️</button>
                            <button type="button" class="toggle-btn">▲</button>
                        </div>
                    </div>
                    <div class="entry-content">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Certification Name</label>
                                <input type="text" name="certifications-${formIndex}-name" class="form-control" placeholder="Certification Name">
                            </div>
                            <div class="form-group">
                                <label>Issuer</label>
                                <input type="text" name="certifications-${formIndex}-issuer" class="form-control" placeholder="Issuing Authority">
                            </div>
                            <div class="form-group">
                                <label>Issue Date</label>
                                <input type="text" name="certifications-${formIndex}-issue_date" class="form-control" placeholder="Month (optional)">
                            </div>
                            <div class="form-group">
                                <label>Issue Year</label>
                                <input type="number" name="certifications-${formIndex}-issue_year" class="form-control" placeholder="Year (optional)">
                            </div>
                            <div class="form-group">
                                <label>Credential ID</label>
                                <input type="text" name="certifications-${formIndex}-credential_id" class="form-control" placeholder="Credential ID (optional)">
                            </div>
                            <div class="form-group">
                                <label>Credential URL</label>
                                <input type="url" name="certifications-${formIndex}-credential_url" class="form-control" placeholder="https://... (optional)">
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        if (entryHTML) {
            container.insertAdjacentHTML('beforeend', entryHTML);
            
            // Add event listeners to new inputs
            const newEntry = container.lastElementChild;
            newEntry.querySelectorAll('input, textarea, select').forEach(input => {
                input.addEventListener('input', updatePreview);
            });
            
            // Expand the new entry
            const entryContent = newEntry.querySelector('.entry-content');
            entryContent.classList.add('expanded');
            newEntry.querySelector('.toggle-btn').textContent = '▼';
            
            updatePreview();
        }
    }
    
    // Initialize preview
    updatePreview();
});
</script>
{% endblock %}
